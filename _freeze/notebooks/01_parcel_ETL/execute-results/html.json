{
  "hash": "66f7702a329d323491068cfdab0be38a",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"NC Parcel Data Sanity Checks\"\nauthor: \"Russell Blessing\"\nformat:\n  html:\n    toc: true\n    theme: cosmo\n    code-fold: true\n    code-summary: \"Show / hide code\"\nexecute:\n  freeze: auto\n  cache: true \n  echo: true\n  message: true\n  warning: false\n---\n\n\n\n## Load libraries\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlibrary(sf)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(knitr)\nlibrary(DBI)\nlibrary(RSQLite)\n```\n:::\n\n\n\n## Point to directories and data\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n# Output directory (external to repo; not tracked by git)\nout_dir <- \"/proj/mhinolab/users/rbless/data/Obstacles_Output\"\ndir.create(out_dir, recursive = TRUE, showWarnings = FALSE)\n\nout_gpkg <- file.path(out_dir, \"parcels_study_area.gpkg\")\nout_csv  <- file.path(out_dir, \"parcels_study_area.csv\")\n\nstudy_area_path <- \"/proj/mhinolab/projects/obstacles/NC_huc6_data_union_sf/NC_huc6_data_union_sf.shp\"\ngpkg_path <- \"/proj/mhinolab/users/rbless/data/parcels/NC_Parcels_all.gpkg\"\nparcels_layer <- \"nc_parcels_poly\" # update if st_layers() indicates otherwise\n```\n:::\n\n\n\n## Study Area\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nstudy_area <- st_read(study_area_path, quiet = TRUE)\n\nstudy_union <- study_area |>\nst_make_valid() |>\nst_union()\n\nggplot() +\ngeom_sf(data = study_union, fill = \"lightblue\", color = \"darkblue\") +\ntheme_minimal() +\nlabs(title = \"Study Area Boundary\")\n```\n\n::: {.cell-output-display}\n![](01_parcel_ETL_files/figure-html/study-area-1.png){width=672}\n:::\n:::\n\n\n\n\n## Identify parcel CRS\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nget_layer_crs <- function(gpkg_path, layer) {\n  sql <- sprintf('SELECT * FROM \"%s\" LIMIT 0', layer)\n  x0 <- sf::st_read(gpkg_path, query = sql, quiet = TRUE)\n  sf::st_crs(x0)\n}\n\nparcel_crs <- get_layer_crs(gpkg_path, parcels_layer)\nparcel_crs$epsg   # should be 2264\n```\n:::\n\n\n## Parcels to Keep\n- cntyfips: The county FIPS code 3-digit\n- parno: The local parcel number for the parcel record\n- altparno: Alternative or local parcel number.\n- nparno: the local parcel number with the state and county FIPS added to the beginning of the local parcel number. \n- siteadd: the full site address as a single field\n- sunit: \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ncon <- dbConnect(RSQLite::SQLite(), gpkg_path)\n\n# Get list of counties present (no geometry)\ncntys <- dbGetQuery(\n  con,\n  sprintf('SELECT DISTINCT cntyfips FROM \"%s\"', parcels_layer)\n)$cntyfips\n\ncols_keep <- c(\"cntyfips\",\"parno\",\"altparno\",\"nparno\",\"siteadd\",\"sunit\",\"scity\",\"szip\",\n               \"mailadd\",\"ownname\",\"ownfrst\",\"ownlast\",\"parval\",\"parusedesc\")\n\ndup_counts <- list()\n\ncntys <- cntys[!is.na(cntys)]\n\n\nfor (c in cntys) {\n  sql <- sprintf('SELECT %s FROM \"%s\" WHERE cntyfips = %s',\n                 paste(sprintf('\"%s\"', cols_keep), collapse=\", \"),\n                 parcels_layer, c)\n\n  x <- st_read(gpkg_path, query = sql, quiet = TRUE) |> st_drop_geometry()\n\n  dup_counts[[as.character(c)]] <- x |>\n    count(cntyfips, parno) |>\n    filter(n > 1)\n}\n\ndup_counts <- bind_rows(dup_counts)\ndup_counts\n\ndup_path <- file.path(out_dir, \"dup_counts_cntyfips_parno.rds\")\nsaveRDS(dup_counts_cntyfips_parno, dup_path)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndup_counts <- readRDS(\"/proj/mhinolab/users/rbless/data/Obstacles_Output/dup_counts_cntyfips_parno.rds\")\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}